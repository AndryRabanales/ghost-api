// ------------------------------------------------------------------
// --- CONFIGURACI√ìN DE CONEXI√ìN Y GENERACI√ìN ---
// ------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
  // Corregido: Solo mantenemos 'driverAdapters' (opcional)
  // y eliminamos el inv√°lido "noDBSchema" que causaba el error P1012.
  previewFeatures = ["driverAdapters"] 
}

datasource db {
  provider = "postgresql"
  // ¬°IMPORTANTE! La URL debe ser la nueva y correcta (sin errores) de Railway
  url      = env("DATABASE_URL") 
}

// ------------------------------------------------------------------
// --- MODELOS DE DATOS ---
// ------------------------------------------------------------------

/// ======================
///     CREATOR (DASHBOARD)
///     ======================
model Creator {
  id                     String    @id
  publicId               String    @unique
  name                   String?
  isPremium              Boolean   @default(false)
  lives                  Int       @default(6)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @default(now()) @updatedAt
  lastUpdated            DateTime  @default(now())
  maxLives               Int       @default(6)
  email                  String?   @unique
  password               String?
  lastActive             DateTime? @default(now())

  // --- üëá CAMPOS DE SUSCRIPCI√ìN (PILAR 3) ---
  premiumExpiresAt       DateTime?
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripeSubscriptionStatus String?

  // --- üëá CAMPOS DE PROPINAS (PILAR 2) ---
  stripeAccountId        String?   @unique
  stripeAccountOnboarded Boolean   @default(false)

  // --- üëá CAMPOS DE FUNCIONES PRO (PILAR 3) ---
  tipOnlyMode            Boolean   @default(false)

  // --- Relaciones ---
  chats                  Chat[]
  messages               Message[]
  links                  ProductLink[]
}

/// =UAL=====================
///     MENSAJES (NGL estilo)
///     ======================
model Message {
  id          String     @id @default(uuid())
  content     String
  createdAt   DateTime   @default(now())
  alias       String?
  creatorId   String
  seen        Boolean    @default(false)
  replyToken  String?    @unique
  creator     Creator    @relation(fields: [creatorId], references: [id])
  responses   Response[]
}

model Response {
  id        String   @id @default(uuid())
  messageId String
  content   String
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id])
}

/// ======================
///     CHATS BIDIRECCIONALES
///     ======================
model Chat {
  id          String        @id @default(uuid())
  creatorId   String
  anonToken   String
  createdAt   DateTime      @default(now())
  anonAlias   String?
  isOpened    Boolean       @default(false)
  anonReplied Boolean       @default(false)
  creator     Creator       @relation(fields: [creatorId], references: [id])
  messages    ChatMessage[]
}

model ChatMessage {
  id                 String   @id @default(uuid())
  chatId             String
  from               String
  content            String
  createdAt          DateTime @default(now())
  seen               Boolean  @default(false)
  alias              String?
  chat               Chat     @relation(fields: [chatId], references: [id])

  // --- üëá CAMPOS PARA PILAR 2 (PROPINAS) ---
  tipAmount          Float?
  tipPaymentIntentId String?  @unique
  tipStatus          String?
}

model Payment {
  id                  String    @id @default(cuid())
  provider            String
  providerPaymentId   String?   @unique
  creatorId           String
  amount              Float
  currency            String
  status              String
  idempotencyKey      String    @unique
  raw                 Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([creatorId])
}

/// ======================
///     CAT√ÅLOGO PRO (PILAR 3)
///     ======================
model ProductLink {
  id        String   @id @default(uuid())
  creatorId String
  title     String
  url       String
  createdAt DateTime @default(now())
  creator   Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
}