// ------------------------------------------------------------------
// --- CONFIGURACIÃ“N DE CONEXIÃ“N Y GENERACIÃ“N ---
// ------------------------------------------------------------------

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"] 
}

datasource db {
  provider = "postgresql"
  // Â¡IMPORTANTE! La URL debe ser la nueva y correcta (sin errores) de Railway
  url      = env("DATABASE_URL") 
}

// ------------------------------------------------------------------
// --- MODELOS DE DATOS ---
// ------------------------------------------------------------------

/// ======================
///     CREATOR (DASHBOARD)
///     ======================
model Creator {
  id                     String    @id
  publicId               String    @unique
  name                   String?
  isPremium              Boolean   @default(false)
  lives                  Int       @default(6)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @default(now()) @updatedAt
  lastUpdated            DateTime  @default(now())
  maxLives               Int       @default(6)
  email                  String?   @unique
  password               String?
  lastActive             DateTime? @default(now())

  // --- ðŸ‘‡ CAMPOS DE SUSCRIPCIÃ“N (PILAR 3) ---
  premiumExpiresAt       DateTime?
  stripeCustomerId       String?   @unique
  stripeSubscriptionId   String?   @unique
  stripeSubscriptionStatus String?

  // --- ðŸ‘‡ CAMPOS DE PROPINAS Y PAGO (PILAR 2, P1, P5) ---
  stripeAccountId        String?   @unique
  stripeAccountOnboarded Boolean   @default(false)

  // --- ðŸ‘‡ CAMPOS DE FUNCIONES PRO / ESCCASEZ (PILAR 2: S1, S3) ---
  tipOnlyMode            Boolean   @default(false)

  // --- CAMPO NUEVO ---
  // Precio base que el creador define (en centavos, ej: 10000 = $100.00 MXN)
  // Lo ponemos en centavos para evitar decimales.
  baseTipAmountCents     Int       @default(10000)
  
  // S1: LÃ­mite de mensajes Premium
  dailyMsgLimit          Int       @default(30) 
  msgCountToday          Int       @default(0)  
  msgCountLastReset      DateTime  @default(now()) 

  // S3: Contrato de Contenido Explicito
  premiumContract        String?   @default("Respuesta de alta calidad.") // <--- CAMPO AÃ‘ADIDO (S3)

  // --- Relaciones ---
  chats                  Chat[]
  messages               Message[]
  links                  ProductLink[]
}

/// =UAL=====================
///     MENSAJES (NGL estilo)
///     ======================
model Message {
  id          String     @id @default(uuid())
  content     String
  createdAt   DateTime   @default(now())
  alias       String?
  creatorId   String
  seen        Boolean    @default(false)
  replyToken  String?    @unique
  creator     Creator    @relation(fields: [creatorId], references: [id])
  responses   Response[]
}

model Response {
  id        String   @id @default(uuid())
  messageId String
  content   String
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id])
}

/// ======================
///     CHATS BIDIRECCIONALES
///     ======================
model Chat {
  id          String        @id @default(uuid())
  creatorId   String
  anonToken   String
  createdAt   DateTime      @default(now())
  anonAlias   String?
  isOpened    Boolean       @default(false)
  anonReplied Boolean       @default(false)
  creator     Creator       @relation(fields: [creatorId], references: [id])
  messages    ChatMessage[]
}

model ChatMessage {
  id                 String   @id @default(uuid())
  chatId             String
  from               String
  content            String
  createdAt          DateTime @default(now())
  seen               Boolean  @default(false)
  alias              String?
  chat               Chat     @relation(fields: [chatId], references: [id])

  // --- ðŸ‘‡ CAMPOS PARA PILAR 2 (PROPINAS) ---
  tipAmount          Float?
  tipPaymentIntentId String?  @unique
  tipStatus          String?

  // --- CAMPO NUEVO ---
  // El "Puntaje de Prioridad" calculado con tu fÃ³rmula
  priorityScore      Float?
  
}

model Payment {
  id                  String    @id @default(cuid())
  provider            String
  providerPaymentId   String?   @unique
  creatorId           String
  amount              Float
  currency            String
  status              String
  idempotencyKey      String    @unique
  raw                 Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([creatorId])
}

/// ======================
///     CATÃLOGO PRO (PILAR 3)
///     ======================
model ProductLink {
  id        String   @id @default(uuid())
  creatorId String
  title     String
  url       String
  createdAt DateTime @default(now())
  creator   Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
}